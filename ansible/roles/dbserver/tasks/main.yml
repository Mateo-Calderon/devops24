---
# tasks file for dbserver
- name: Ensure MariaDB-server is installed
  ansible.builtin.package:
    name: mariadb-server
    state: present

- name: Ensure MariaDB service is started and enabled at boot
  ansible.builtin.service:
    name: mariadb
    state: started
    enabled: true

- name: Ensure Python MySQL library is installed
  ansible.builtin.package:
    name: python3-PyMySQL
    state: present

- name: Create a database called webappdb
  community.mysql.mysql_db:
    name: webappdb
    state: present
    login_unix_socket: /var/lib/mysql/mysql.sock

- name: Create a user for the web application (password stored securely)
  community.mysql.mysql_user:
    name: webappuser
    password: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      37383664643564313637616363343762613835396239613336343730316233343561663037376637
      3364653337383639623766356266613232666637313334390a376662323264373337646236393762
      62386433343539653931393932643437376564346634636230313237303662333932333930383334
      3665653165666434350a613537353630323632383636363430366562376139663832323135333433
      39613739383637313039323334623531326563663162366164626266396230633264313030353936
      3237333939653862316663663030343035666231353030623837
    
    priv: 'webappdb.*:ALL'
    host: localhost
    state: present
    login_unix_socket: /var/lib/mysql/mysql.sock

- name: Ensure deploy user exists
  user:
    name: deploy
    state: present

- name: Copy all .md files from files/ to deploys home
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "/home/deploy"
    owner: deploy
    group: deploy
    mode: '0644'
  with_fileglob:
    - "/home/gato/ansible/files/*.md"
